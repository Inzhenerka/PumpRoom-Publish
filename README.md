# PumpRoom Publish

GitHub Action для загрузки заданий в LMS PumpRoom

Это действие упаковывает репозиторий в ZIP-архив и загружает его на платформу
PumpRoom.

## Возможности

- Создает ZIP-архив указанного каталога
- Автоматически исключает каталоги `.git` и `.github`
- Позволяет указать дополнительные файлы/каталоги для исключения
- Загружает архив в API PumpRoom
- Предоставляет подробные сообщения об ошибках в случае неудачной загрузки

## Использование

Чтобы использовать это действие в вашем рабочем процессе, добавьте следующий
шаг:

```yaml
steps:
  - name: Checkout
    uses: actions/checkout@v4

  - name: Upload to PumpRoom
    uses: inzhenerka/pumproom-publish@v1
    with:
      # Каталог для архивации и загрузки (по умолчанию корень репозитория)
      root_dir: ''

      # Файлы и каталоги для исключения (разделенные запятыми)
      # .git и .github всегда исключаются
      ignore: 'node_modules,dist,coverage'

      # Обязательно: Идентификатор области для репозитория
      realm: 'your-realm-name'

      # Обязательно: Имя репозитория
      repo_name: 'your-repo-name'

      # Обязательно: API-ключ для аутентификации
      api_key: ${{ secrets.PUMPROOM_API_KEY }}
```

### Входные параметры

| Параметр    | Описание                                        | Обязательный | По умолчанию              |
| ----------- | ----------------------------------------------- | ------------ | ------------------------- |
| `root_dir`  | Каталог для архивации и загрузки                | Нет          | `''` (корень репозитория) |
| `ignore`    | Файлы и каталоги для исключения (через запятую) | Нет          | `''`                      |
| `realm`     | Идентификатор области для репозитория           | Да           | Н/Д                       |
| `repo_name` | Имя репозитория                                 | Да           | Н/Д                       |
| `api_key`   | API-ключ для аутентификации                     | Да           | Н/Д                       |

### Пример рабочего процесса

```yaml
name: Upload to PumpRoom

on:
  push:
    branches: [main]

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Upload to PumpRoom
        uses: inzhenerka/pumproom-publish@v1
        with:
          realm: 'production'
          repo_name: 'my-awesome-repo'
          ignore: 'node_modules,dist,coverage'
          api_key: ${{ secrets.PUMPROOM_API_KEY }}
```

> **Примечание:** Убедитесь, что вы сохранили свой API-ключ как секрет в
> настройках вашего репозитория.

## Начальная настройка

После клонирования репозитория на локальную машину или в codespace, вам
необходимо выполнить несколько начальных шагов настройки, прежде чем вы сможете
разрабатывать свое действие.

> [!ПРИМЕЧАНИЕ]
>
> Вам понадобится достаточно современная версия [Node.js](https://nodejs.org)
> (20.x или новее должна работать!). Если вы используете менеджер версий, такой
> как [`nodenv`](https://github.com/nodenv/nodenv) или
> [`fnm`](https://github.com/Schniz/fnm), этот шаблон имеет файл `.node-version`
> в корне репозитория, который может использоваться для автоматического
> переключения на правильную версию при переходе в репозиторий с помощью `cd`.
> Кроме того, этот файл `.node-version` используется GitHub Actions в любых
> действиях `actions/setup-node`.

1. :hammer_and_wrench: Установите зависимости

   ```bash
   bun install
   ```

1. :building_construction: Упакуйте TypeScript для распространения

   ```bash
   bun bundle
   ```

1. :white_check_mark: Запустите тесты

   ```bash
   $ bun run test

   PASS  ./index.test.js
     ✓ throws invalid number (3ms)
     ✓ wait 500 ms (504ms)
     ✓ test runs (95ms)

   ...
   ```

## Обновление метаданных действия

Файл [`action.yml`](action.yml) определяет метаданные о вашем действии, такие
как входные и выходные параметры. Подробнее об этом файле см.
[Синтаксис метаданных для GitHub Actions](https://docs.github.com/en/actions/creating-actions/metadata-syntax-for-github-actions).

При копировании этого репозитория обновите `action.yml` с именем, описанием,
входными и выходными параметрами для вашего действия.

## Обновление кода действия

Каталог [`src/`](./src/) является сердцем вашего действия! Он содержит исходный
код, который будет выполняться при вызове вашего действия. Вы можете заменить
содержимое этого каталога своим собственным кодом.

При написании кода действия следует помнить о нескольких вещах:

- Большинство операций с инструментарием GitHub Actions и CI/CD обрабатываются
  асинхронно. В `main.ts` вы увидите, что действие выполняется в `async`
  функции.

  ```javascript
  import * as core from '@actions/core'
  //...

  async function run() {
    try {
      //...
    } catch (error) {
      core.setFailed(error.message)
    }
  }
  ```

  Для получения дополнительной информации об инструментарии GitHub Actions см.
  [документацию](https://github.com/actions/toolkit/blob/main/README.md).

Так чего же вы ждете? Приступайте к настройке вашего действия!

1. Создайте новую ветку

   ```bash
   git checkout -b v1
   ```

1. Замените содержимое `src/` кодом вашего действия
1. Добавьте тесты в `__tests__/` для вашего исходного кода
1. Отформатируйте, протестируйте и соберите действие

   ```bash
   bun all
   ```

   > Этот шаг важен! Он запустит [`rollup`](https://rollupjs.org/) для сборки
   > окончательного JavaScript-кода действия со всеми включенными зависимостями.
   > Если вы не выполните этот шаг, ваше действие не будет работать корректно
   > при использовании в рабочем процессе.

1. (Опционально) Протестируйте ваше действие локально

   Утилита [`@github/local-action`](https://github.com/github/local-action)
   может использоваться для локального тестирования вашего действия. Это простой
   инструмент командной строки, который "имитирует" (или симулирует)
   инструментарий GitHub Actions. Таким образом, вы можете запускать ваше
   TypeScript-действие локально, не публикуя изменения в репозиторий.

   Утилита `local-action` может быть запущена следующими способами:
   - Отладчик Visual Studio Code

     Убедитесь, что вы просмотрели и, при необходимости, обновили
     [`.vscode/launch.json`](./.vscode/launch.json)

   - Терминал/Командная строка

     ```bash
     # npx @github/local action <action-yaml-path> <entrypoint> <dotenv-file>
     npx @github/local-action . src/main.ts .env
     ```

   Вы можете предоставить файл `.env` для CLI `local-action` для установки
   переменных окружения, используемых инструментарием GitHub Actions. Например,
   установка входных данных и данных полезной нагрузки событий, используемых
   вашим действием. Для получения дополнительной информации см. пример файла
   [`.env.example`](./.env.example) и
   [документацию GitHub Actions](https://docs.github.com/en/actions/learn-github-actions/variables#default-environment-variables).

1. Зафиксируйте ваши изменения

   ```bash
   git add .
   git commit -m "My first action is ready!"
   ```

1. Отправьте их в ваш репозиторий

   ```bash
   git push -u origin v1
   ```

1. Создайте pull request и получите обратную связь по вашему действию
1. Объедините pull request в ветку `main`

Ваше действие опубликовано! :rocket:

Для получения информации о версионировании вашего действия см.
[Версионирование](https://github.com/actions/toolkit/blob/main/docs/action-versioning.md)
в инструментарии GitHub Actions.

## Проверка действия

Теперь вы можете проверить действие, ссылаясь на него в файле рабочего процесса.
Например, [`ci.yml`](./.github/workflows/ci.yml) демонстрирует, как ссылаться на
действие в том же репозитории.

```yaml
steps:
  - name: Checkout
    id: checkout
    uses: actions/checkout@v4

  - name: Test Local Action
    id: test-action
    uses: ./
    with:
      milliseconds: 1000

  - name: Print Output
    id: output
    run: echo "${{ steps.test-action.outputs.time }}"
```

Для примеров выполнения рабочих процессов, посмотрите
[вкладку Actions](https://github.com/actions/typescript-action/actions)!
:rocket:

## Публикация нового релиза

Этот проект включает вспомогательный скрипт
[`script/release`](./script/release), разработанный для упрощения процесса
тегирования и отправки новых релизов для GitHub Actions.

GitHub Actions позволяет пользователям выбирать определенную версию действия для
использования на основе тегов релиза. Этот скрипт упрощает этот процесс,
выполняя следующие шаги:

1. **Получение последнего тега релиза:** Скрипт начинает с получения самого
   последнего тега релиза SemVer текущей ветки, просматривая локальные данные,
   доступные в вашем репозитории.
1. **Запрос нового тега релиза:** Затем пользователю предлагается ввести новый
   тег релиза. Для помощи скрипт отображает тег, полученный на предыдущем шаге,
   и проверяет формат введенного тега (vX.X.X). Пользователю также напоминается
   обновить поле версии в package.json.
1. **Тегирование нового релиза:** Затем скрипт тегирует новый релиз и
   синхронизирует отдельный основной тег (например, v1, v2) с новым тегом релиза
   (например, v1.0.0, v2.1.2). Когда пользователь создает новый основной релиз,
   скрипт автоматически определяет это и создает ветку `releases/v#` для
   предыдущей основной версии.
1. **Отправка изменений в удаленный репозиторий:** Наконец, скрипт отправляет
   необходимые коммиты, теги и ветки в удаленный репозиторий. Отсюда вам нужно
   будет создать новый релиз в GitHub, чтобы пользователи могли легко ссылаться
   на новые теги в своих рабочих процессах.

1. Сохраните и зафиксируйте изменения

После завершения этот рабочий процесс будет запускаться каждый раз при создании
pull request или при прямой отправке изменений в `main`. Если рабочий процесс
обнаружит какие-либо зависимости с отсутствующими или несоответствующими
лицензиями, он завершит рабочий процесс с ошибкой и предоставит подробную
информацию о найденных проблемах.
